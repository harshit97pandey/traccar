Ext.define("Traccar.Style",{singleton:!0,panelPadding:10,windowWidth:640,windowHeight:480,dateTimeFormat:"Y-m-d H:i:s",timeFormat:"H:i",dateFormat:"Y-m-d",weekStartDay:1,deviceWidth:350,reportHeight:250,reportTime:100,mapDefaultLat:51.507222,mapDefaultLon:-0.1275,mapDefaultZoom:6,mapRouteColor:"rgba(21, 127, 204, 1.0)",mapRouteWidth:4,mapArrowStrokeColor:"rgba(50, 50, 50, 1.0)",mapArrowStrokeWidth:1,mapTextColor:"rgba(50, 50, 50, 1.0)",mapTextStrokeColor:"rgba(255, 255, 255, 1.0)",mapTextStrokeWidth:1,
mapTextOffset:10,mapTextFont:"bold 12px sans-serif",mapColorOnline:"rgba(77, 250, 144, 1.0)",mapColorUnknown:"rgba(250, 190, 77, 1.0)",mapColorOffline:"rgba(255, 84, 104, 1.0)",mapColorReport:"rgba(21, 127, 204, 1.0)",mapColorReportSelected:"rgba(194, 221, 242, 1.0)",mapRadiusNormal:7,mapRadiusSelected:14,mapMaxZoom:19,mapDelay:500,coordinatePrecision:6,numberPrecision:2});
Ext.define("Traccar.AttributeFormatter",{singleton:!0,coordinateFormatter:function(a){return a.toFixed(Traccar.Style.coordinatePrecision)},speedFormatter:function(a){return Ext.getStore("SpeedUnits").formatValue(a,Traccar.app.getPreference("speedUnit"))},courseFormatter:function(a){return"N NE E SE S SW W NW".split(" ")[Math.floor(a/45)]},distanceFormatter:function(a){return Ext.getStore("DistanceUnits").formatValue(a,Traccar.app.getPreference("distanceUnit"))},defaultFormatter:function(a){return"number"===
typeof a?Number(a.toFixed(Traccar.Style.numberPrecision)):"boolean"===typeof a?a?Ext.Msg.buttonText.yes:Ext.Msg.buttonText.no:a instanceof Date?Ext.Date.format(a,Traccar.Style.dateTimeFormat):a},getFormatter:function(a){return"latitude"===a||"longitude"===a?this.coordinateFormatter:"speed"===a?this.speedFormatter:"course"===a?this.courseFormatter:"distance"===a||"odometer"===a?this.distanceFormatter:this.defaultFormatter}});
Ext.define("Traccar.model.Server",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"id",type:"int"},{name:"registration",type:"boolean"},{name:"readonly",type:"boolean"},{name:"map",type:"string"},{name:"bingKey",type:"string"},{name:"mapUrl",type:"string"},{name:"language",type:"string"},{name:"distanceUnit",type:"string"},{name:"speedUnit",type:"string"},{name:"latitude",type:"float"},{name:"longitude",type:"float"},{name:"zoom",type:"int"}],proxy:{type:"ajax",url:"/api/server",actionMethods:{update:"PUT"},
writer:{type:"json",writeAllFields:!0}}});
Ext.define("Traccar.model.User",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"email",type:"string"},{name:"password",type:"string"},{name:"admin",type:"boolean"},{name:"map",type:"string"},{name:"language",type:"string"},{name:"distanceUnit",type:"string"},{name:"speedUnit",type:"string"},{name:"latitude",type:"float"},{name:"longitude",type:"float"},{name:"zoom",type:"int"}],proxy:{type:"rest",url:"/api/users",writer:{type:"json",writeAllFields:!0}}});
Ext.define("Traccar.model.Device",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"id",type:"int"},{name:"name",type:"string"},{name:"uniqueId",type:"string"},{name:"status",type:"string"},{name:"lastUpdate",type:"date",dateWriteFormat:"c"}]});
Ext.define("Traccar.model.Position",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"id",type:"int"},{name:"protocol",type:"string"},{name:"deviceId",type:"int"},{name:"serverTime",type:"date"},{name:"deviceTime",type:"date"},{name:"fixTime",type:"date"},{name:"valid",type:"boolean"},{name:"latitude",type:"float"},{name:"longitude",type:"float"},{name:"altitude",type:"float"},{name:"speed",type:"float"},{name:"course",type:"float"},{name:"address",type:"string"},{name:"attributes"}]});
Ext.define("Traccar.model.Attribute",{extend:Ext.data.Model,fields:[{name:"priority",type:"int"},{name:"name",type:"string"},{name:"value",type:"string"}]});Ext.define("Traccar.model.Command",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"deviceId",type:"int"},{name:"type",type:"string"},{name:"attributes"}]});Ext.define("Traccar.model.Polygon",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"id",type:"int"},{name:"type",type:"string"},{name:"name",type:"string"},{name:"coordinates"}]});
Ext.define("Traccar.model.Alert",{extend:Ext.data.Model,identifier:"negative",fields:[{name:"id",type:"int"},{name:"deviceId",type:"int"},{name:"deviceName",type:"string"},{name:"polygonId",type:"int"},{name:"polygonName",type:"string"},{name:"creationDate",type:"date"},{name:"cancelDate",type:"date"}]});Ext.define("Traccar.store.Devices",{extend:Ext.data.Store,model:"Traccar.model.Device",proxy:{type:"rest",url:"/api/devices",writer:{writeAllFields:!0}}});
Ext.define("Traccar.store.AllDevices",{extend:Ext.data.Store,model:"Traccar.model.Device",proxy:{type:"rest",url:"/api/devices",extraParams:{all:!0}}});Ext.define("Traccar.store.Positions",{extend:Ext.data.Store,model:"Traccar.model.Position",proxy:{type:"rest",url:"/api/positions"}});Ext.define("Traccar.store.LatestPositions",{extend:Ext.data.Store,model:"Traccar.model.Position"});
Ext.define("Traccar.store.Users",{extend:Ext.data.Store,model:"Traccar.model.User",proxy:{type:"rest",url:"/api/users",writer:{writeAllFields:!0}}});Ext.define("Traccar.store.Attributes",{extend:Ext.data.Store,model:"Traccar.model.Attribute",sorters:[{property:"priority"}]});
Ext.define("Traccar.store.MapTypes",{extend:Ext.data.Store,fields:["key","name"],data:[{name:"OpenStreetMaps"},{name:"Bing Road"},{name:"Bing Areal"},{name:"Google Roads"},{name:"Google Satelite"},{name:"Google Hybrid"},{name:"ArcGis Topo"},{name:"ArcGis Imagery"}]});
Ext.define("Traccar.store.DistanceUnits",{extend:Ext.data.Store,fields:["key","name","factor"],data:[{key:"km",name:Strings.sharedKm,factor:0.001},{key:"mi",name:Strings.sharedMi,factor:6.21371E-4}],formatValue:function(a,b){var c;return b?(c=this.findRecord("key",b),(a*c.get("factor")).toFixed(2)+" "+c.get("name")):a}});
Ext.define("Traccar.store.SpeedUnits",{extend:Ext.data.Store,fields:["key","name","factor"],data:[{key:"kmh",name:Strings.sharedKmh,factor:1.852},{key:"mph",name:Strings.sharedMph,factor:1.15078}],formatValue:function(a,b){var c;return b?(c=this.findRecord("key",b),(a*c.get("factor")).toFixed(1)+" "+c.get("name")):a}});
Ext.define("Traccar.store.CommandTypes",{extend:Ext.data.Store,fields:["key","name"],data:[{key:"positionPeriodic",name:Strings.commandPositionPeriodic},{key:"positionStop",name:Strings.commandPositionStop},{key:"engineStop",name:Strings.commandEngineStop},{key:"engineResume",name:Strings.commandEngineResume}]});
Ext.define("Traccar.store.TimeUnits",{extend:Ext.data.Store,fields:["name","factor"],data:[{name:Strings.sharedSecond,factor:1},{name:Strings.sharedMinute,factor:60},{name:Strings.sharedHour,factor:3600}]});Ext.define("Traccar.store.Languages",{extend:Ext.data.Store,fields:["code","name"],data:function(){var a,b=[];for(a in Locale.languages)Locale.languages.hasOwnProperty(a)&&b.push({code:a,name:Locale.languages[a].name});return b}()});
Ext.define("Traccar.store.Polygons",{extend:Ext.data.Store,model:"Traccar.model.Polygon",identifier:"negative",proxy:{type:"ajax",api:{create:"/api/polygon/add",read:"/api/polygon/list",update:"/api/polygon/update",destroy:"/api/polygon/remove"},reader:{type:"json"},writer:{type:"json",writeAllFields:!0}}});Ext.define("Traccar.store.Alerts",{extend:Ext.data.Store,model:"Traccar.model.Alert",proxy:{type:"rest",url:"/api/notifications/list"}});
Ext.define("Traccar.view.BaseDialog",{extend:Ext.window.Window,bodyPadding:Traccar.Style.panelPadding,resizable:!1,modal:!0});
Ext.define("Traccar.view.CommandDialogController",{extend:Ext.app.ViewController,alias:"controller.commandDialog",onSelect:function(a){this.lookupReference("paramPositionPeriodic").setHidden("positionPeriodic"!==a.getValue())},onSendClick:function(a){var b,c;a=a.up("window").down("form");a.updateRecord();c=a.getRecord();"positionPeriodic"===c.get("type")&&(a=this.lookupReference("paramPositionPeriodic"),b=a.down('numberfield[name\x3d"frequency"]').getValue(),b*=a.down('combobox[name\x3d"unit"]').getValue(),
c.set("attributes",{frequency:b}));Ext.Ajax.request({scope:this,url:"/api/commands",jsonData:c.getData(),callback:this.onSendResult})},onSendResult:function(a,b,c){b?(Ext.toast(Strings.commandSent),this.closeView()):Traccar.app.showError(c)}});
Ext.define("Traccar.view.CommandDialog",{extend:Traccar.view.BaseDialog,controller:"commandDialog",title:Strings.commandTitle,items:{xtype:"form",items:[{xtype:"combobox",name:"type",fieldLabel:Strings.commandType,store:"CommandTypes",displayField:"name",valueField:"key",listeners:{select:"onSelect"}},{xtype:"fieldcontainer",reference:"paramPositionPeriodic",name:"attributes",hidden:!0,items:[{xtype:"numberfield",fieldLabel:Strings.commandFrequency,name:"frequency"},{xtype:"combobox",fieldLabel:Strings.commandUnit,
name:"unit",store:"TimeUnits",displayField:"name",valueField:"factor"}]}]},buttons:[{text:Strings.commandSend,handler:"onSendClick"},{text:Strings.sharedCancel,handler:"closeView"}]});Ext.define("Traccar.view.BaseEditDialog",{extend:Traccar.view.BaseDialog,buttons:[{text:Strings.sharedSave,handler:"onSaveClick"},{text:Strings.sharedCancel,handler:"closeView"}]});
Ext.define("Traccar.view.BaseEditDialogController",{extend:Ext.app.ViewController,alias:"controller.baseEditDialog",onSaveClick:function(a){var b,c;b=a.up("window").down("form");b.updateRecord();b=b.getRecord();(c=b.store)?(b.phantom&&c.add(b),c.sync({failure:function(a){c.rejectChanges();Traccar.app.showError(a.exceptions[0].getError().response)}})):b.save();a.up("window").close()}});
Ext.define("Traccar.view.DeviceDialog",{extend:Traccar.view.BaseEditDialog,controller:"baseEditDialog",title:Strings.deviceDialog,items:{xtype:"form",items:[{xtype:"textfield",name:"name",fieldLabel:Strings.deviceName,allowBlank:!1},{xtype:"textfield",name:"uniqueId",fieldLabel:Strings.deviceIdentifier,allowBlank:!1}]}});
Ext.define("Traccar.view.DevicesController",{extend:Ext.app.ViewController,alias:"controller.devices",config:{listen:{controller:{"*":{selectDevice:"selectDevice",selectReport:"selectReport"}}}},init:function(){var a=Traccar.app.getServer().get("readonly")&&!Traccar.app.getUser().get("admin");this.lookupReference("toolbarAddButton").setVisible(!a);this.lookupReference("toolbarEditButton").setVisible(!a);this.lookupReference("toolbarRemoveButton").setVisible(!a)},onAddClick:function(){var a,b;a=Ext.create("Traccar.model.Device");
a.store=this.getView().getStore();b=Ext.create("Traccar.view.DeviceDialog");b.down("form").loadRecord(a);b.show()},onEditClick:function(){var a,b;a=this.getView().getSelectionModel().getSelection()[0];b=Ext.create("Traccar.view.DeviceDialog");b.down("form").loadRecord(a);b.show()},onRemoveClick:function(){var a=this.getView().getSelectionModel().getSelection()[0];Ext.Msg.show({title:Strings.deviceDialog,message:Strings.sharedRemoveConfirm,buttons:Ext.Msg.YESNO,buttonText:{yes:Strings.sharedRemove,
no:Strings.sharedCancel},fn:function(b){"yes"===b&&(b=Ext.getStore("Devices"),b.remove(a),b.sync())}})},onCommandClick:function(){var a,b;a=this.getView().getSelectionModel().getSelection()[0];b=Ext.create("Traccar.model.Command");b.set("deviceId",a.get("id"));a=Ext.create("Traccar.view.CommandDialog");a.down("form").loadRecord(b);a.show()},onSelectionChange:function(a){var b=0===a.getCount();this.lookupReference("toolbarEditButton").setDisabled(b);this.lookupReference("toolbarRemoveButton").setDisabled(b);
this.lookupReference("deviceCommandButton").setDisabled(b);b||this.fireEvent("selectDevice",a.getLastSelected(),!0)},selectDevice:function(a){this.getView().getSelectionModel().select([a],!1,!0)},selectReport:function(a){void 0!==a&&this.getView().getSelectionModel().deselectAll()}});
Ext.define("Traccar.view.EditToolbar",{extend:Ext.toolbar.Toolbar,xtype:"editToolbar",initComponent:function(){this.callParent(arguments);this.add(0,[{xtype:"button",handler:"onAddClick",reference:"toolbarAddButton",glyph:"xf067@FontAwesome",tooltip:Strings.sharedAdd,tooltipType:"title"},{xtype:"button",disabled:!0,handler:"onEditClick",reference:"toolbarEditButton",glyph:"xf040@FontAwesome",tooltip:Strings.sharedEdit,tooltipType:"title"},{xtype:"button",disabled:!0,handler:"onRemoveClick",reference:"toolbarRemoveButton",
glyph:"xf00d@FontAwesome",tooltip:Strings.sharedRemove,tooltipType:"title"}])}});Ext.define("Traccar.view.RegisterController",{extend:Ext.app.ViewController,alias:"controller.register",onCreateClick:function(){var a=this.lookupReference("form");a.isValid()&&Ext.Ajax.request({scope:this,method:"POST",url:"/api/users",jsonData:a.getValues(),callback:this.onCreateReturn})},onCreateReturn:function(a,b,c){b?(this.closeView(),Ext.toast(Strings.loginCreated)):Traccar.app.showError(c)}});
Ext.define("Traccar.view.Register",{extend:Traccar.view.BaseDialog,controller:"register",title:Strings.loginRegister,items:{xtype:"form",reference:"form",jsonSubmit:!0,items:[{xtype:"combobox",name:"language",fieldLabel:Strings.loginLanguage,store:"Languages",displayField:"name",valueField:"code",submitValue:!1,reference:"languageField"},{xtype:"textfield",name:"name",fieldLabel:Strings.userName,allowBlank:!1},{xtype:"textfield",name:"email",fieldLabel:Strings.userEmail,vtype:"email",allowBlank:!1},
{xtype:"textfield",name:"password",fieldLabel:Strings.userPassword,inputType:"password",allowBlank:!1},{xtype:"checkbox",fieldLabel:"Personal",checked:!0},{xtype:"textfield",fieldLabel:"Company name",disabled:!0}]},buttons:[{text:Strings.sharedSave,handler:"onCreateClick"},{text:Strings.sharedCancel,handler:"closeView"}]});
Ext.define("Traccar.view.LoginController",{extend:Ext.app.ViewController,alias:"controller.login",init:function(){},login:function(){var a=this.lookupReference("form");a.isValid()&&(Ext.getBody().mask(Strings.sharedLoading),Ext.Ajax.request({scope:this,method:"POST",url:"/api/session",params:a.getValues(),callback:function(a,c){Ext.getBody().unmask();c?this.fireViewEvent("login"):Traccar.app.showError(Strings.loginFailed)}}))},logout:function(){Ext.Ajax.request({scope:this,method:"DELETE",url:"/api/session",
callback:function(){window.location.reload()}})},onSelectLanguage:function(a){var b,c;a=a.getValue();b=window.location.href;0<=b.indexOf("locale\x3d")?(c=b.substring(0,b.indexOf("locale")),b=b.substring(b.indexOf("locale")),b=b.substring(b.indexOf("\x3d")+1),b=0<=b.indexOf("\x26")?b.substring(b.indexOf("\x26")):"",b=c+"locale\x3d"+a+b):b=0>b.indexOf("?")?b+("?locale\x3d"+a):b+("\x26locale\x3d"+a);window.location.href=b},onAfterRender:function(a){a.focus()},onSpecialKey:function(a,b){b.getKey()===
b.ENTER&&this.login()},onLoginClick:function(){Ext.getElementById("submitButton").click();this.login()},onRegisterClick:function(){Ext.create("Traccar.view.Register").show()}});
Ext.define("Traccar.view.UserDialogController",{extend:Ext.app.ViewController,alias:"controller.userDialog",init:function(){Traccar.app.getUser().get("admin")&&this.lookupReference("adminField").setDisabled(!1)},onSaveClick:function(a){var b,c;b=a.up("window").down("form");b.updateRecord();b=b.getRecord();b===Traccar.app.getUser()?b.save():(c=Ext.getStore("Users"),b.phantom&&c.add(b),c.sync({failure:function(a){c.rejectChanges();Traccar.app.showError(a.exceptions[0].getError().response)}}));a.up("window").close()}});
Ext.define("Traccar.view.UserDialog",{extend:Traccar.view.BaseEditDialog,controller:"userDialog",title:Strings.settingsUser,items:{xtype:"form",items:[{xtype:"textfield",name:"name",fieldLabel:Strings.userName},{xtype:"textfield",name:"email",fieldLabel:Strings.userEmail,allowBlank:!1},{xtype:"textfield",name:"password",fieldLabel:Strings.userPassword,inputType:"password",allowBlank:!1},{xtype:"checkboxfield",name:"admin",fieldLabel:Strings.userAdmin,allowBlank:!1,disabled:!0,reference:"adminField"},
{xtype:"combobox",name:"map",fieldLabel:Strings.mapLayer,store:"MapTypes",displayField:"name",valueField:"name"},{xtype:"combobox",name:"distanceUnit",fieldLabel:Strings.settingsDistanceUnit,store:"DistanceUnits",displayField:"name",valueField:"key"},{xtype:"combobox",name:"speedUnit",fieldLabel:Strings.settingsSpeedUnit,store:"SpeedUnits",displayField:"name",valueField:"key"},{xtype:"numberfield",name:"latitude",fieldLabel:Strings.positionLatitude,decimalPrecision:Traccar.Style.coordinatePrecision},
{xtype:"numberfield",name:"longitude",fieldLabel:Strings.positionLongitude,decimalPrecision:Traccar.Style.coordinatePrecision},{xtype:"numberfield",name:"zoom",fieldLabel:Strings.serverZoom}]}});
Ext.define("Traccar.view.ServerDialog",{extend:Traccar.view.BaseEditDialog,controller:"baseEditDialog",title:Strings.serverTitle,items:{xtype:"form",items:[{xtype:"checkboxfield",name:"registration",fieldLabel:Strings.serverRegistration,allowBlank:!1},{xtype:"checkboxfield",name:"readonly",fieldLabel:Strings.serverReadonly,allowBlank:!1},{xtype:"combobox",name:"map",fieldLabel:Strings.mapLayer,store:"MapTypes",displayField:"name",valueField:"name"},{xtype:"combobox",name:"distanceUnit",fieldLabel:Strings.settingsDistanceUnit,
store:"DistanceUnits",displayField:"name",valueField:"key"},{xtype:"combobox",name:"speedUnit",fieldLabel:Strings.settingsSpeedUnit,store:"SpeedUnits",displayField:"name",valueField:"key"},{xtype:"numberfield",name:"latitude",fieldLabel:Strings.positionLatitude,decimalPrecision:Traccar.Style.coordinatePrecision},{xtype:"numberfield",name:"longitude",fieldLabel:Strings.positionLongitude,decimalPrecision:Traccar.Style.coordinatePrecision},{xtype:"numberfield",name:"zoom",fieldLabel:Strings.serverZoom}]}});
Ext.define("Traccar.view.UserDevicesController",{extend:Ext.app.ViewController,alias:"controller.userDevices",init:function(){this.userId=this.getView().user.getData().id;this.getView().getStore().load({scope:this,callback:function(){Ext.create("Traccar.store.Devices").load({params:{userId:this.userId},scope:this,callback:function(a,b,c){if(c)for(b=0;b<a.length;b++)c=this.getView().getStore().find("id",a[b].getData().id),this.getView().getSelectionModel().select(c,!0,!0)}})}})},onBeforeSelect:function(a,
b){Ext.Ajax.request({scope:this,url:"/api/permissions",jsonData:{userId:this.userId,deviceId:b.getData().id},callback:function(a,b,d){b||Traccar.app.showError(d)}})},onBeforeDeselect:function(a,b){Ext.Ajax.request({scope:this,method:"DELETE",url:"/api/permissions",jsonData:{userId:this.userId,deviceId:b.getData().id},callback:function(a,b,d){b||Traccar.app.showError(d)}})}});
Ext.define("Traccar.view.UserDevices",{extend:Ext.grid.Panel,xtype:"userDevicesView",controller:"userDevices",store:"AllDevices",selModel:{selType:"checkboxmodel",checkOnly:!0,showHeaderCheckbox:!1},listeners:{beforedeselect:"onBeforeDeselect",beforeselect:"onBeforeSelect"},columns:[{text:Strings.deviceName,dataIndex:"name",flex:1},{text:Strings.deviceIdentifier,dataIndex:"uniqueId",flex:1}]});
Ext.define("Traccar.view.BaseWindow",{extend:Ext.window.Window,width:Traccar.Style.windowWidth,height:Traccar.Style.windowHeight,layout:"fit",modal:!0});
Ext.define("Traccar.view.UsersController",{extend:Ext.app.ViewController,alias:"controller.users",init:function(){Ext.getStore("Users").load()},onAddClick:function(){var a,b;a=Ext.create("Traccar.model.User");b=Ext.create("Traccar.view.UserDialog");b.down("form").loadRecord(a);b.show()},onEditClick:function(){var a,b;a=this.getView().getSelectionModel().getSelection()[0];b=Ext.create("Traccar.view.UserDialog");b.down("form").loadRecord(a);b.show()},onRemoveClick:function(){var a=this.getView().getSelectionModel().getSelection()[0];
Ext.Msg.show({title:Strings.settingsUser,message:Strings.sharedRemoveConfirm,buttons:Ext.Msg.YESNO,buttonText:{yes:Strings.sharedRemove,no:Strings.sharedCancel},fn:function(b){var c=Ext.getStore("Users");"yes"===b&&(c.remove(a),c.sync())}})},onDevicesClick:function(){var a=this.getView().getSelectionModel().getSelection()[0];Ext.create("Traccar.view.BaseWindow",{title:Strings.deviceTitle,items:{xtype:"userDevicesView",user:a}}).show()},onSelectionChange:function(a){a=0<a.length;this.lookupReference("toolbarEditButton").setDisabled(a);
this.lookupReference("toolbarRemoveButton").setDisabled(a);this.lookupReference("userDevicesButton").setDisabled(a)}});
Ext.define("Traccar.view.Users",{extend:Ext.grid.Panel,xtype:"usersView",controller:"users",store:"Users",selType:"rowmodel",tbar:{xtype:"editToolbar",items:[{text:Strings.deviceTitle,disabled:!0,handler:"onDevicesClick",reference:"userDevicesButton"}]},listeners:{selectionchange:"onSelectionChange"},columns:[{text:Strings.userName,dataIndex:"name",flex:1},{text:Strings.userEmail,dataIndex:"email",flex:1},{text:Strings.userAdmin,dataIndex:"admin",flex:1}]});
Ext.define("Traccar.view.SettingsMenuController",{extend:Ext.app.ViewController,alias:"controller.settings",init:function(){Traccar.app.getUser().get("admin")&&(this.lookupReference("settingsServerButton").setHidden(!1),this.lookupReference("settingsUsersButton").setHidden(!1))},onUserClick:function(){var a=Ext.create("Traccar.view.UserDialog");a.down("form").loadRecord(Traccar.app.getUser());a.show()},onServerClick:function(){var a=Ext.create("Traccar.view.ServerDialog");a.down("form").loadRecord(Traccar.app.getServer());
a.show()},onUsersClick:function(){Ext.create("Traccar.view.BaseWindow",{title:Strings.settingsUsers,modal:!1,items:{xtype:"usersView"}}).show()},onLogoutClick:function(){Ext.create("Traccar.view.LoginController").logout()}});
Ext.define("Traccar.view.SettingsMenu",{extend:Ext.button.Button,xtype:"settingsMenu",glyph:"xf013@FontAwesome",text:Strings.settingsTitle,menu:{controller:"settings",items:[{text:Strings.settingsUser,handler:"onUserClick"},{text:Strings.settingsServer,hidden:!0,handler:"onServerClick",reference:"settingsServerButton"},{text:Strings.settingsUsers,hidden:!0,handler:"onUsersClick",reference:"settingsUsersButton"},{text:Strings.loginLogout,handler:"onLogoutClick"}]}});
Ext.define("Traccar.view.Devices",{extend:Ext.grid.Panel,xtype:"devicesView",controller:"devices",store:"Devices",title:Strings.deviceTitle,selType:"rowmodel",tbar:{xtype:"editToolbar",items:[{disabled:!0,handler:"onCommandClick",reference:"deviceCommandButton",glyph:"xf093@FontAwesome",tooltip:Strings.deviceCommand,tooltipType:"title"},{xtype:"tbfill"},{id:"deviceFollowButton",glyph:"xf05b@FontAwesome",tooltip:Strings.deviceFollow,tooltipType:"title",enableToggle:!0},{xtype:"settingsMenu"}]},listeners:{selectionchange:"onSelectionChange"},
columns:[{text:Strings.deviceName,dataIndex:"name",flex:1},{text:Strings.deviceLastUpdate,dataIndex:"lastUpdate",flex:1,renderer:function(a,b,c){switch(c.get("status")){case "online":b.tdCls="status-color-online";break;case "offline":b.tdCls="status-color-offline";break;default:b.tdCls="status-color-unknown"}return Ext.Date.format(a,Traccar.Style.dateTimeFormat)}}]});
Ext.define("Traccar.view.PolygonsController",{extend:Ext.app.ViewController,alias:"controller.polygons",onSelectionChange:function(a){var b=0===a.getCount();this.lookupReference("toolbarEditButton").setDisabled(b);this.lookupReference("toolbarRemoveButton").setDisabled(b);this.lookupReference("toolbarLinkButton").setDisabled(b);this.lookupReference("toolbarUnlinkButton").setDisabled(b);b||this.fireEvent("showArea",a.getLastSelected().data)},onAddPolygonClick:function(){this.fireEvent("drawArea","Polygon")},
onAddCircleClick:function(){this.fireEvent("drawArea","Circle")},onAddLineClick:function(){this.fireEvent("drawArea","LineString")},onAddSquareClick:function(){this.fireEvent("drawArea","Square")},onRemoveClick:function(){var a=this.getView().getSelectionModel().getSelection()[0];store=Ext.getStore("Polygons");store.remove(a);store.sync()},onLinkClick:function(){var a=this.getView().getSelectionModel().getSelection()[0],b=Ext.getStore("Devices");Ext.Ajax.request({scope:this,url:"/api/polygon/link",
method:"POST",params:{polygonId:a.id,deviceId:b.getAt(0).getData().id},callback:function(){Ext.toast("Link applied")}})},onUnlinkClick:function(){var a=this.getView().getSelectionModel().getSelection()[0],b=Ext.getStore("Devices");Ext.Ajax.request({scope:this,url:"/api/polygon/unlink",method:"POST",params:{polygonId:a.id,deviceId:b.getAt(0).getData().id},callback:function(){Ext.toast("Link applied")}})}});
Ext.define("Traccar.view.Polygons",{extend:Ext.grid.Panel,xtype:"polygonsView",controller:"polygons",store:"Polygons",title:"Polygons",layout:"fit",tbar:{items:[{xtype:"button",reference:"toolbarAddButton",glyph:"xf067@FontAwesome",tooltip:Strings.sharedAdd,tooltipType:"title",menu:[{text:"Polygon",handler:"onAddPolygonClick"},{text:"Line",handler:"onAddLineClick"},{text:"Circle",handler:"onAddCircleClick"},{text:"Square",handler:"onAddSquareClick"}]},{xtype:"button",disabled:!0,handler:"onEditClick",
reference:"toolbarEditButton",glyph:"xf040@FontAwesome",tooltip:Strings.sharedEdit,tooltipType:"title"},{xtype:"button",disabled:!0,handler:"onRemoveClick",reference:"toolbarRemoveButton",glyph:"xf00d@FontAwesome",tooltip:Strings.sharedRemove,tooltipType:"title"},{xtype:"button",disabled:!0,glyph:"xf0c1@FontAwesome",reference:"toolbarLinkButton",handler:"onLinkClick",tooltip:"Link",tooltipType:"title"},{xtype:"button",disabled:!0,reference:"toolbarUnlinkButton",glyph:"xf127@FontAwesome",handler:"onUnlinkClick",
tooltip:"Unlink",tooltipType:"title"}]},listeners:{selectionchange:"onSelectionChange"},columns:[{text:Strings.deviceName,dataIndex:"name",flex:1},{text:Strings.deviceName,dataIndex:"type",flex:1}]});
Ext.define("Traccar.view.StateController",{extend:Ext.app.ViewController,alias:"controller.state",config:{listen:{controller:{"*":{selectDevice:"selectDevice",selectReport:"selectReport"}},store:{"#LatestPositions":{add:"updateLatest",update:"updateLatest"},"#Positions":{clear:"clearReport"}}}},keys:function(){var a,b,c;c={};b="fixTime latitude longitude valid altitude speed course address protocol".split(" ");for(a=0;a<b.length;a++)c[b[a]]={priority:a,name:Strings["position"+b[a].replace(/^\w/g,
function(a){return a.toUpperCase()})]};return c}(),updateLatest:function(a,b){var c;Ext.isArray(b)||(b=[b]);for(c=0;c<b.length;c++)this.deviceId===b[c].get("deviceId")&&this.updatePosition(b[c])},formatValue:function(a){return"number"===typeof id?Number(a.toFixed(2)):a},updatePosition:function(a){var b,c;b=Ext.getStore("Attributes");b.removeAll();for(c in a.data)a.data.hasOwnProperty(c)&&void 0!==this.keys[c]&&b.add(Ext.create("Traccar.model.Attribute",{priority:this.keys[c].priority,name:this.keys[c].name,
value:Traccar.AttributeFormatter.getFormatter(c)(a.get(c))}));a=a.get("attributes");if(a instanceof Object)for(c in a)a.hasOwnProperty(c)&&b.add(Ext.create("Traccar.model.Attribute",{priority:1024,name:c.replace(/^./,function(a){return a.toUpperCase()}),value:Traccar.AttributeFormatter.getFormatter(c)(a[c])}))},selectDevice:function(a){this.deviceId=a.get("id");(a=Ext.getStore("LatestPositions").findRecord("deviceId",this.deviceId,0,!1,!1,!0))?this.updatePosition(a):Ext.getStore("Attributes").removeAll()},
selectReport:function(a){this.deviceId=null;this.updatePosition(a)},clearReport:function(){Ext.getStore("Attributes").removeAll()}});Ext.define("Traccar.view.State",{extend:Ext.grid.Panel,xtype:"stateView",controller:"state",store:"Attributes",title:Strings.stateTitle,columns:[{text:Strings.stateName,dataIndex:"name",flex:1},{text:Strings.stateValue,dataIndex:"value",flex:1}]});
Ext.define("Traccar.view.ReportController",{extend:Ext.app.ViewController,alias:"controller.report",config:{listen:{controller:{"*":{selectDevice:"selectDevice",selectReport:"selectReport"}}}},onShowClick:function(){var a,b,c,e,d,f=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"\x3d"+encodeURIComponent(a[c]));return b.join("\x26")};exportButton=this.lookupReference("exportButton");exportButton.setDisabled(!0);this.lookupReference("deviceField").isValid()?(a=this.lookupReference("deviceField").getValue(),
b=this.lookupReference("fromDateField").getValue(),c=this.lookupReference("fromTimeField").getValue(),b=new Date(b.getFullYear(),b.getMonth(),b.getDate(),c.getHours(),c.getMinutes(),c.getSeconds(),c.getMilliseconds()),c=this.lookupReference("toDateField").getValue(),e=this.lookupReference("toTimeField").getValue(),c=new Date(c.getFullYear(),c.getMonth(),c.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()),d={deviceId:a,from:b.toISOString(),to:c.toISOString()},a=Ext.getStore("Positions"),
a.load({params:d,callback:function(a,b,c){c&&0<a.length&&(exportButton.setHref("api/report/csv?"+f(d)),exportButton.setDisabled(!1))}})):Ext.toast("Fill required fields")},onClearClick:function(){Ext.getStore("Positions").removeAll()},onSelectionChange:function(a){0<a.getCount()&&this.fireEvent("selectReport",a.getLastSelected(),!0)},selectDevice:function(a){a&&this.getView().getSelectionModel().deselectAll()},selectReport:function(a){this.getView().getSelectionModel().select([a],!1,!0)}});
Ext.define("Traccar.view.Report",{extend:Ext.grid.Panel,xtype:"reportView",controller:"report",store:"Positions",title:Strings.reportTitle,tbar:[{xtype:"tbtext",html:Strings.reportDevice},{xtype:"combobox",reference:"deviceField",store:"Devices",valueField:"id",displayField:"name",typeAhead:!0,queryMode:"local",allowBlank:!1},"-",{xtype:"tbtext",html:Strings.reportFrom},{xtype:"datefield",reference:"fromDateField",startDay:Traccar.Style.weekStartDay,format:Traccar.Style.dateFormat,value:new Date((new Date).getTime()-
18E5)},{xtype:"timefield",reference:"fromTimeField",maxWidth:Traccar.Style.reportTime,format:Traccar.Style.timeFormat,value:new Date((new Date).getTime()-18E5)},"-",{xtype:"tbtext",html:Strings.reportTo},{xtype:"datefield",reference:"toDateField",startDay:Traccar.Style.weekStartDay,format:Traccar.Style.dateFormat,value:new Date},{xtype:"timefield",reference:"toTimeField",maxWidth:Traccar.Style.reportTime,format:Traccar.Style.timeFormat,value:new Date},"-",{text:Strings.reportShow,handler:"onShowClick"},
{href:"#",text:"Export",hrefTarget:"_blank",reference:"exportButton",disabled:!0},{text:Strings.reportClear,handler:"onClearClick"}],listeners:{selectionchange:"onSelectionChange"},columns:[{text:Strings.positionValid,dataIndex:"valid",flex:1,renderer:Traccar.AttributeFormatter.getFormatter("valid")},{text:Strings.positionFixTime,dataIndex:"fixTime",flex:1.5,xtype:"datecolumn",align:"right",renderer:Traccar.AttributeFormatter.getFormatter("fixTime")},{text:Strings.positionLatitude,dataIndex:"latitude",
flex:1,align:"right",renderer:Traccar.AttributeFormatter.getFormatter("latitude")},{text:Strings.positionLongitude,dataIndex:"longitude",flex:1,align:"right",renderer:Traccar.AttributeFormatter.getFormatter("latitude")},{text:Strings.positionAltitude,dataIndex:"altitude",flex:1,align:"right",renderer:Traccar.AttributeFormatter.getFormatter("altitude")},{text:Strings.positionSpeed,dataIndex:"speed",flex:1,align:"right",renderer:Traccar.AttributeFormatter.getFormatter("speed")},{text:Strings.positionAddress,
dataIndex:"address",flex:3,renderer:Traccar.AttributeFormatter.getFormatter("address")}]});
Ext.define("Traccar.view.AlertController",{extend:Ext.app.ViewController,alias:"controller.alert",onSeenClick:function(){var a=this.getView().getSelectionModel();0<a.getCount()&&(a=a.getSelection()[0].getData().id,Ext.Ajax.request({scope:this,url:"/api/notifications/seen",params:{notificationId:a},method:"POST",callback:function(){var a=this.lookupReference("seenCheck").getValue();console.log(a);Ext.getStore("Alerts").load({params:{all:a}});Ext.toast("Alert marked as seen")}}))},onAllChange:function(a,
b){Ext.getStore("Alerts").load({params:{all:b}})},onSelectionChange:function(a){0<a.getCount()&&(seen=a.getLastSelected().getData().seen,this.lookupReference("seenButton").setDisabled(seen))}});
Ext.define("Traccar.view.Alert",{extend:Ext.grid.Panel,xtype:"alertView",controller:"alert",store:"Alerts",title:"Alerts",tbar:[{text:"Mark as read",handler:"onSeenClick",disabled:!0,reference:"seenButton"},{xtype:"checkbox",handler:"onAllChange",reference:"seenCheck"}],listeners:{selectionchange:"onSelectionChange"},columns:[{text:"seen",dataIndex:"seen",flex:1,renderer:Traccar.AttributeFormatter.getFormatter("seen")},{text:"polygonName",dataIndex:"polygonName",flex:1,renderer:Traccar.AttributeFormatter.getFormatter("polygonName")},
{text:"deviceName",dataIndex:"deviceName",flex:1,renderer:Traccar.AttributeFormatter.getFormatter("deviceName")},{text:Strings.positionFixTime,dataIndex:"creationDate",flex:1.5,xtype:"datecolumn",align:"right",renderer:Traccar.AttributeFormatter.getFormatter("creationDate")},{text:Strings.positionFixTime,dataIndex:"cancelDate",flex:1.5,xtype:"datecolumn",align:"right",renderer:Traccar.AttributeFormatter.getFormatter("cancelDate")}]});
Ext.define("Traccar.view.MapController",{extend:Ext.app.ViewController,alias:"controller.map",config:{listen:{controller:{"*":{selectDevice:"selectDevice",selectReport:"selectReport",drawArea:"drawArea",showArea:"showArea"}},store:{"#Devices":{add:"updateDevice",update:"updateDevice"},"#LatestPositions":{add:"updateLatest",update:"updateLatest"},"#Positions":{load:"loadReport",clear:"clearReport"}},component:{"#":{selectFeature:"selectFeature"}}}},init:function(){this.latestMarkers={};this.reportMarkers=
{}},getDeviceColor:function(a){switch(a.get("status")){case "online":return Traccar.Style.mapColorOnline;case "offline":return Traccar.Style.mapColorOffline;default:return Traccar.Style.mapColorUnknown}},changeMarkerColor:function(a,b){return new ol.style.Style({image:new ol.style.Arrow({radius:a.getImage().getRadius(),fill:new ol.style.Fill({color:b}),stroke:a.getImage().getStroke(),rotation:a.getImage().getRotation()}),text:a.getText()})},updateDevice:function(a,b){var c,e,d;Ext.isArray(b)||(b=
[b]);for(c=0;c<b.length;c++)e=b[c],d=e.get("id"),d in this.latestMarkers&&(d=this.latestMarkers[d],d.setStyle(this.changeMarkerColor(d.getStyle(),this.getDeviceColor(e))))},followSelected:function(){return Ext.getCmp("deviceFollowButton")&&Ext.getCmp("deviceFollowButton").pressed},updateLatest:function(a,b){var c,e,d,f,h,g;Ext.isArray(b)||(b=[b]);for(c=0;c<b.length;c++)e=b[c],h=e.get("deviceId"),f=Ext.getStore("Devices").findRecord("id",h,0,!1,!1,!0),d=new ol.geom.Point(ol.proj.fromLonLat([e.get("longitude"),
e.get("latitude")])),h in this.latestMarkers?(g=this.latestMarkers[h],g.setGeometry(d)):(g=new ol.Feature(d),g.set("record",f),this.latestMarkers[h]=g,this.getView().getLatestSource().addFeature(g),d=this.getLatestMarker(this.getDeviceColor(f)),d.getText().setText(f.get("name")),g.setStyle(d)),g.getStyle().getImage().setRotation(e.get("course")*Math.PI/180),g===this.selectedMarker&&this.followSelected()&&this.getView().getMapView().setCenter(g.getGeometry().getCoordinates())},loadReport:function(a,
b){var c,e,d,f,h;this.clearReport(a);this.reportRoute=new ol.Feature({geometry:new ol.geom.LineString([])});this.reportRoute.setStyle(this.getRouteStyle());this.getView().getRouteSource().addFeature(this.reportRoute);for(c=0;c<b.length;c++)e=b[c],d=ol.proj.fromLonLat([e.get("longitude"),e.get("latitude")]),f=new ol.geom.Point(d),f=new ol.Feature(f),f.set("record",e),this.reportMarkers[e.get("id")]=f,this.getView().getReportSource().addFeature(f),h=this.getReportMarker(),h.getImage().setRotation(e.get("course")*
Math.PI/180),f.setStyle(h),this.reportRoute.getGeometry().appendCoordinate(d)},clearReport:function(){var a;this.reportRoute&&(this.getView().getRouteSource().removeFeature(this.reportRoute),this.reportRoute=null);if(this.reportMarkers){for(a in this.reportMarkers)this.reportMarkers.hasOwnProperty(a)&&this.getView().getReportSource().removeFeature(this.reportMarkers[a]);this.reportMarkers={}}},getRouteStyle:function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:Traccar.Style.mapRouteColor,
width:Traccar.Style.mapRouteWidth})})},getMarkerStyle:function(a,b){return new ol.style.Style({image:new ol.style.Arrow({radius:a,fill:new ol.style.Fill({color:b}),stroke:new ol.style.Stroke({color:Traccar.Style.mapArrowStrokeColor,width:Traccar.Style.mapArrowStrokeWidth})}),text:new ol.style.Text({textBaseline:"bottom",fill:new ol.style.Fill({color:Traccar.Style.mapTextColor}),stroke:new ol.style.Stroke({color:Traccar.Style.mapTextStrokeColor,width:Traccar.Style.mapTextStrokeWidth}),offsetY:-a/2-
Traccar.Style.mapTextOffset,font:Traccar.Style.mapTextFont})})},getLatestMarker:function(a){return this.getMarkerStyle(Traccar.Style.mapRadiusNormal,a)},getReportMarker:function(){return this.getMarkerStyle(Traccar.Style.mapRadiusNormal,Traccar.Style.mapColorReport)},getReportSelected:function(){return this.getMarkerStyle(Traccar.Style.mapRadiusSelected,Traccar.Style.mapColorReportSelected)},resizeMarker:function(a,b){return new ol.style.Style({image:new ol.style.Arrow({radius:b,fill:a.getImage().getFill(),
stroke:a.getImage().getStroke(),rotation:a.getImage().getRotation()}),text:a.getText()})},resizeColorMarker:function(a,b,c){return new ol.style.Style({image:new ol.style.Arrow({radius:b,fill:new ol.style.Fill({color:c}),stroke:a.getImage().getStroke(),rotation:a.getImage().getRotation()}),text:a.getText()})},selectMarker:function(a,b,c){this.selectedMarker&&this.selectedStyle&&this.selectedMarker.setStyle(this.selectedStyle);a&&(this.selectedStyle=a.getStyle(),c?a.setStyle(this.resizeColorMarker(a.getStyle(),
Traccar.Style.mapRadiusSelected,Traccar.Style.mapColorReportSelected)):a.setStyle(this.resizeMarker(a.getStyle(),Traccar.Style.mapRadiusSelected)),b&&this.getView().getMapView().setCenter(a.getGeometry().getCoordinates()));this.selectedMarker=a},selectDevice:function(a,b){this.selectMarker(this.latestMarkers[a.get("id")],b)},selectReport:function(a,b){this.selectMarker(this.reportMarkers[a.get("id")],b,!0)},selectFeature:function(a){(a=a.get("record"))&&(a instanceof Traccar.model.Device?this.fireEvent("selectDevice",
a,!1):this.fireEvent("selectReport",a,!1))},showArea:function(a){for(var b=this.getView().getVectorSource(),c=[],e=0;e<a.coordinates.length;e++){var d=a.coordinates[e];c.push(ol.proj.fromLonLat([d.longitude,d.latitude]))}a=new ol.geom.Polygon([c]);a=new ol.Feature(a);b.clear();b.addFeature(a)},drawArea:function(a){var b=this.getView().getVectorSource();b.clear();var c=this.getView().getMap(),e;if("None"!==a){var d;"Circle"===a?d=ol.interaction.Draw.createRegularPolygon(32):"Square"===a&&(a="Circle",
d=ol.interaction.Draw.createRegularPolygon(4));e=new ol.interaction.Draw({source:b,type:a,geometryFunction:d,maxPoints:void 0});c.addInteraction(e);e.on("drawend",function(b){b=b.feature.getGeometry().getCoordinates()[0];for(var d=[],g=0;g<b.length;g++){var k=b[g],k=ol.proj.toLonLat([k[0],k[1]]);d.push({longitude:k[0],latitude:k[1]})}Ext.Msg.prompt("Name","Area name:",function(b,f){if("ok"==b&&f){var g={type:a,name:f,coordinates:d};store=Ext.getStore("Polygons");store.add(g);Ext.toast("Polygon saved");
store.sync()}c.removeInteraction(e)})})}}});
Ext.define("Traccar.view.Map",{extend:Ext.form.Panel,xtype:"mapView",header:!1,controller:"map",title:Strings.mapTitle,layout:"fit",getMap:function(){return this.map},getMapView:function(){return this.mapView},getLatestSource:function(){return this.latestSource},getRouteSource:function(){return this.routeSource},getReportSource:function(){return this.reportSource},getVectorSource:function(){return this.vectorSource},listeners:{afterrender:function(){var a,b,c,e,d,f,h,g,k;d=function(a,b){return new ol.layer.Tile({source:new ol.source.XYZ({url:a,
attributions:[new ol.Attribution({html:""})]}),projection:b,visible:!1})};f=function(a){return new ol.layer.Tile({source:new ol.source.BingMaps({key:"Atabw4WpqrmFXz8yRA9yxMzk2u--7Znu5POGdRsivAkyFw-6QAeOtwgMU8Upcb-W",imagerySet:a}),visible:!1})};var l=new ol.layer.Tile({source:new ol.source.OSM({}),visible:!1});e=f("Road");f=f("Aerial");var m=d("http://mt0.google.com/vt/lyrs\x3dy\x26hl\x3den\x26x\x3d{x}\x26y\x3d{y}\x26z\x3d{z}\x26s\x3dGa"),n=d("http://mt0.google.com/vt/lyrs\x3ds\x26hl\x3den\x26x\x3d{x}\x26y\x3d{y}\x26z\x3d{z}\x26s\x3dGa");
h=d("http://mt0.google.com/vt/lyrs\x3dm\x26hl\x3den\x26x\x3d{x}\x26y\x3d{y}\x26z\x3d{z}\x26s\x3dGa");g=d("http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}.png");d=d("http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png");var j=[{name:"OpenStreetMaps",layer:l},{name:"Bing Road",layer:e},{name:"Bing Areal",layer:f},{name:"Google Roads",layer:h},{name:"Google Satelite",layer:n},{name:"Google Hybrid",layer:m},
{name:"ArcGis Topo",layer:g},{name:"ArcGis Imagery",layer:d}],l=function(a){var b=document.createElement("button");b.className="ol-save-button fa-floppy-o";b.title="Save location";b.addEventListener("click",function(){for(var b,c=0;c<j.length;++c)j[c].layer.getVisible()&&(b=j[c].name);Ext.Ajax.request({scope:this,url:"/api/users/location/update",method:"POST",params:{map:b,zoom:a.getView().getZoom(),longitude:ol.proj.toLonLat(a.getView().getCenter())[0],latitude:ol.proj.toLonLat(a.getView().getCenter())[1]},
callback:function(){Ext.toast("Location saved")}})},!1);var c=document.createElement("div");c.className="ol-unselectable ol-control ol-save-div";c.appendChild(b);ol.control.Control.call(this,{element:c})};ol.inherits(l,ol.control.Control);m=function(){var a=document.createElement("select");a.className="ol-layers-select";for(var b=0,d=0;d<j.length;++d){var e=document.createElement("option");e.text=j[d].name;e.value=j[d].name;j[d].name==c&&(b=d,j[d].layer.setVisible(!0));a.add(e)}a.selectedIndex=b;
a.addEventListener("change",function(){for(var b=0;b<j.length;++b)j[b].layer.setVisible(a.value===j[b].name)},!1);b=document.createElement("div");b.className="ol-unselectable ol-control ol-layers-div";b.appendChild(a);ol.control.Control.call(this,{element:b})};ol.inherits(m,ol.control.Control);a=Traccar.app.getUser();b=Traccar.app.getServer();c=a.get("map")||b.get("map");this.latestSource=new ol.source.Vector({});e=new ol.layer.Vector({source:this.latestSource});this.routeSource=new ol.source.Vector({});
d=new ol.layer.Vector({source:this.routeSource});this.reportSource=new ol.source.Vector({});f=new ol.layer.Vector({source:this.reportSource});this.vectorSource=new ol.source.Vector({wrapX:!1});n=new ol.layer.Vector({source:this.vectorSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})});h=a.get("latitude")||b.get("latitude")||
Traccar.Style.mapDefaultLat;g=a.get("longitude")||b.get("longitude")||Traccar.Style.mapDefaultLon;a=a.get("zoom")||b.get("zoom")||Traccar.Style.mapDefaultZoom;this.mapView=new ol.View({center:ol.proj.fromLonLat([g,h]),zoom:a,maxZoom:Traccar.Style.mapMaxZoom});h=[];for(g=0;g<j.length;++g)h.push(j[g].layer);h.push(d);h.push(f);h.push(e);h.push(n);this.map=new ol.Map({target:this.body.dom.id,layers:h,view:this.mapView,interactions:ol.interaction.defaults().extend([new ol.interaction.DragRotateAndZoom])});
m=new m(this.map);this.map.addControl(m);e=new ol.control.ScaleLine;this.map.addControl(e);e=new ol.control.ZoomSlider;this.map.addControl(e);e=new ol.control.MousePosition({projection:ol.proj.get("EPSG:4326"),coordinateFormat:function(a){return a[0].toFixed(6)+" "+a[1].toFixed(6)}});this.map.addControl(e);e=new ol.control.FullScreen;this.map.addControl(e);l=new l(this.map);this.map.addControl(l);k=this.map.getTarget();"string"===typeof k&&(k=Ext.get(k).dom);this.map.on("pointermove",function(a){k.style.cursor=
this.forEachFeatureAtPixel(a.pixel,function(){return!0})?"pointer":""});this.map.on("click",function(a){this.map.forEachFeatureAtPixel(a.pixel,function(a){this.fireEvent("selectFeature",a)},this)},this)},resize:function(){this.map.updateSize()}}});
Ext.define("Traccar.view.Main",{extend:Ext.container.Viewport,alias:"widget.main",layout:"border",defaults:{header:!1,collapsible:!0,split:!0},items:[{region:"west",layout:"border",width:Traccar.Style.deviceWidth,title:Strings.deviceTitle,header:!0,collapsed:!0,defaults:{split:!0,flex:1},items:[{region:"center",header:!1,xtype:"devicesView",flex:1},{region:"south",xtype:"stateView",flex:1,header:!1,collapsible:!0},{region:"north",header:!1,xtype:"polygonsView",flex:1}]},{xtype:"panel",region:"south",
height:Traccar.Style.reportHeight,collapsed:!0,titleCollapse:!0,floatable:!1,title:"Alerts \x26 Reports",layout:"accordion",items:[{xtype:"alertView"},{xtype:"reportView"}]},{region:"center",xtype:"mapView",header:!1,collapsible:!1}]});
Ext.define("Traccar.view.MainMobile",{extend:Ext.container.Viewport,alias:"widget.mainMobile",layout:"border",defaults:{header:!1,collapsible:!0,split:!0},items:[{region:"east",xtype:"stateView",flex:4,collapsed:!0,titleCollapse:!0,floatable:!1},{region:"center",xtype:"mapView",collapsible:!1,flex:2},{region:"south",xtype:"devicesView",flex:1}]});
Ext.define("Traccar.controller.Root",{extend:Ext.app.Controller,init:function(){var a=document.createElement("div");a.className="state-indicator";document.body.appendChild(a);this.isPhone=0!==parseInt(window.getComputedStyle(a).getPropertyValue("z-index"),10)},onLaunch:function(){Ext.get("spinner").remove();Ext.Ajax.request({scope:this,url:"/api/session",callback:this.onSessionReturn})},onSessionReturn:function(a,b,c){b?(a=Ext.decode(c.responseText),a.valid?(Traccar.app.setServer(a.server),Traccar.app.setUser(a.user),
this.loadApp()):location.href="login.html"):Traccar.app.showError(c)},loadApp:function(){Ext.getStore("Devices").load();Ext.getStore("Alerts").load();Ext.getStore("Polygons").load();Ext.get("attribution").remove();this.isPhone?Ext.create("widget.mainMobile"):Ext.create("widget.main");this.startWebSocket()},startWebSocket:function(){var a;a="https:"===location.protocol?"wss:":"ws:";a+="//"+location.host;a+=location.pathname+"api/ws/positions/";websocket=new WebSocket(a);websocket.onopen=function(){Ext.toast("Connection to server established")};
websocket.onclose=function(){Ext.toast("Connection to server closed")};websocket.onmessage=function(a){var c,e,d,f,h;message=Ext.decode(a.data);if("position"==message.type){a=message.body;d=a.devices;f=a.positions;c=Ext.getStore("Devices");e=Ext.getStore("LatestPositions");for(a=0;a<d.length;a++)(h=c.findRecord("id",d[a].id,0,!1,!1,!0))&&h.set({status:d[a].status,lastUpdate:d[a].lastUpdate},{dirty:!1});for(a=0;a<f.length;a++)(d=e.findRecord("deviceId",f[a].deviceId,0,!1,!1,!0))?d.set(f[a]):e.add(Ext.create("Traccar.model.Position",
f[a]))}};websocket.onerror=function(a){Ext.toast("Server connection error: "+a.data)}}});
Ext.define("Traccar.Application",{extend:Ext.app.Application,name:"Traccar",models:"Server User Device Position Attribute Command Polygon Alert".split(" "),stores:"Devices AllDevices Positions LatestPositions Users Attributes MapTypes DistanceUnits SpeedUnits CommandTypes TimeUnits Languages Polygons Alerts".split(" "),controllers:["Root"],setUser:function(a){this.user=Ext.create("Ext.data.reader.Json",{model:"Traccar.model.User"}).readRecords(a).getRecords()[0]},getUser:function(){return this.user},
setServer:function(a){this.server=Ext.create("Ext.data.reader.Json",{model:"Traccar.model.Server"}).readRecords(a).getRecords()[0]},getServer:function(){return this.server},getPreference:function(a,b){return this.getUser().get(a)||this.getServer().get(a)||b},showError:function(a){Ext.isString(a)?Ext.Msg.alert(Strings.errorTitle,a):a.responseText?(a=Ext.decode(a.responseText),a.details?Ext.Msg.alert(Strings.errorTitle,a.details):Ext.Msg.alert(Strings.errorTitle,a.message)):a.statusText?Ext.Msg.alert(Strings.errorTitle,
a.statusText):Ext.Msg.alert(Strings.errorTitle,Strings.errorConnection)}});Ext.application({name:"Traccar",extend:Traccar.Application});